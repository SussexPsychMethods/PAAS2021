###------------------------------------------------------------------------###
###                 Simple script for building the index page              ###
###------------------------------------------------------------------------###
require 'erb'
require 'asciidoctor'

weeks = [*1..11]


lecture_links =
{11 => "https://sussex.cloud.panopto.eu/Panopto/Pages/Viewer.aspx?id=41353405-6da7-4130-8c69-adf9010793bb",
 9 => "https://sussex.cloud.panopto.eu/Panopto/Pages/Viewer.aspx?id=8153bbfb-e5fd-486a-b70f-adeb0107dca0",
 8 => "https://sussex.cloud.panopto.eu/Panopto/Pages/Viewer.aspx?id=896d6177-f7f4-4d69-9237-ade40107c7fe",
 7 => "https://sussex.cloud.panopto.eu/Panopto/Pages/Viewer.aspx?id=c1bc339e-c286-4faf-94c2-addd0109c30e",
 6 => "https://sussex.cloud.panopto.eu/Panopto/Pages/Viewer.aspx?id=91a3f770-54f1-49d8-913c-add600fcfb4a",
 5 => "https://sussex.cloud.panopto.eu/Panopto/Pages/Viewer.aspx?id=7b70145a-58ae-4460-aecd-adcf00e65b20",
 4 => "https://sussex.cloud.panopto.eu/Panopto/Pages/Viewer.aspx?id=d2b679d7-4e1b-4852-b999-adc800c77e94",
 3 => "https://sussex.cloud.panopto.eu/Panopto/Pages/Viewer.aspx?id=84fbc924-90d0-45b5-9dcd-adc100f57e09",
 2 => "https://sussex.cloud.panopto.eu/Panopto/Pages/Viewer.aspx?id=bebface4-c004-4498-8253-adba00f495e7",
 1 => "https://sussex.cloud.panopto.eu/Panopto/Pages/Viewer.aspx?id=b2a0c475-184d-4e2f-91a4-adb300e673cd"}




Materials = Struct.new(
  :type,
  :subtype,
  :week,
  :link,
  :week_int,
  :desc
)

class String
  # String
  (1..5).to_a.each do |x|
    define_method "h#{x}" do
      return '=' * x + ' ' + self if self != ''
    end
  end
  def trim
    return gsub!(/src/, '') if include?('src')
  end
end

class NilClass
  def trim
    nil
  end
end

def tidy_type(type)
  return 'lecture' if type == 'lectures'

  return 'practical' if type == 'practicals'

  return 'tutorial' if type == 'tutorials'
end

def make_link_text(type, subtype)
  if type == 'tutorials'
    tidy_type(type)
  else
    "#{tidy_type(type)} #{subtype}"
  end
end

def list_html(type, week, subtype)
  if type == 'tutorials'
    Dir["src/#{type}/#{week}/index.html"][0]
  else
    Dir["src/#{type}/#{week}/#{subtype}/index.html"][0]
  end
end

def list_pdf(type, week, subtype)
  if type == 'tutorials'
    Dir["src/#{type}/#{week}/*.pdf"][0]
  else
    Dir["src/#{type}/#{week}/#{subtype}/*.pdf"][0]
  end
end

def list_description(type, week)
  desc = Dir["src/#{type}/#{week}/*.md"][0]
  if desc.nil?
    ''
  else
    File.read(desc)
  end
end

def add_pdf_to_link(link_text, link, pdf)
  return "link:#{link.trim}[Link to #{link_text}]" if pdf.nil?

  "link:#{link.trim}[Link to #{link_text}] (link:#{pdf.trim}[pdf])"
end

def add_solutions(link_text)
  solution = link_text.gsub('index.html','index.html?solutions=true').gsub('Link to practical worksheet','Link to solution sheet')
  return "#{link_text} (#{solution})"

end

def make_materials(week, week_int, type, subtype)
  link = list_html(type, week, subtype)
  pdf = list_pdf(type, week, subtype)
  desc = list_description(type, week)
  return nil if link.nil?

  link_text = make_link_text(type, subtype)
  link_text = add_pdf_to_link(link_text, link, pdf)
  if week_int >= 7 && subtype == "worksheet"
    link_text = add_solutions(link_text) 
  end

  Materials.new(type, subtype, "Week #{week}", link_text, week_int, desc)
end

class Lecture
  def initialize(week)
    @week = format('%<week>02d', week: week)
    @week_int = week
    @subtypes = %w[slides handout]
    @type = 'lectures'
  end

  def listfiles
    @subtypes.flat_map { |subtype| make_materials(@week, @week_int, @type, subtype) }
  end
end

class Practical
  def initialize(week)
    @week = format('%<week>02d', week: week)
    @week_int = week
    @subtypes = %w[slides worksheet]
    @type = 'practicals'
  end

  def listfiles
    @subtypes.flat_map { |subtype| make_materials(@week, @week_int, @type, subtype) }
  end
end

class Tutorial
  def initialize(week)
    @week = format('%<week>02d', week: week)
    @week_int = week
    @subtypes = %w[tutorials]
    @type = 'tutorials'
  end

  def listfiles
    @subtypes.flat_map { |subtype| make_materials(@week, @week_int, @type, subtype) }
  end
end

lecture_list = weeks.flat_map { |week| Lecture.new(week).listfiles }
lecture_list.compact!

practical_list = weeks.flat_map { |week| Practical.new(week).listfiles }
practical_list.compact!

tutorial_list = weeks.flat_map { |week| Tutorial.new(week).listfiles }
tutorial_list.compact!

puts lecture_list
puts practical_list
puts tutorial_list

template = ERB.new(File.read('./src/index.md'))

index_page = template.result_with_hash(lectureList: lecture_list,
                                       practicalList: practical_list,
                                       tutorialList: tutorial_list,
                                       videoList: lecture_links)
File.write('./src/index.asc', index_page)
Asciidoctor.render_file('./src/index.asc')
